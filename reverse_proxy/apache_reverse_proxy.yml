---
- name: Set up Apache reverse proxy with Let's Encrypt SSL
  hosts: localhost
  become: yes
  connection: local
  vars:
    domain_name: "{{ domain_name }}"
    local_port: "{{ local_port }}"
    webroot_path: "/var/www/html"
    temp_config: "/etc/apache2/sites-available/{{ domain_name }}.conf"

  tasks:
    - name: Install Apache and Certbot
      apt:
        name:
          - apache2
          - python3-certbot-apache
          - certbot
        state: present
        update_cache: yes

    - name: Enable required Apache modules
      command: a2enmod "{{ item }}"
      args:
        creates: "/etc/apache2/mods-enabled/{{ item }}.load"
      loop:
        - proxy
        - proxy_http
        - ssl
        - headers
        - rewrite

    - name: Disable default Apache site
      command: a2dissite 000-default.conf
      args:
        removes: "/etc/apache2/sites-enabled/000-default.conf"
      notify:
        - reload apache

    - name: Ensure webroot directory exists
      file:
        path: "{{ webroot_path }}"
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: Create temporary Apache virtual host configuration (HTTP only)
      template:
        src: temp_http.conf.j2
        dest: "{{ temp_config }}"
      notify:
        - reload apache

    - name: Enable Apache site
      command: a2ensite "{{ domain_name }}.conf"
      args:
        creates: "/etc/apache2/sites-enabled/{{ domain_name }}.conf"
      notify:
        - reload apache

    - name: Obtain Let's Encrypt SSL certificate
      command: >
        certbot certonly --webroot -w {{ webroot_path }} -n --agree-tos --email admin@{{ domain_name }} -d {{ domain_name }}
      args:
        creates: "/etc/letsencrypt/live/{{ domain_name }}/fullchain.pem"

    - name: Create final Apache virtual host configuration (with SSL)
      template:
        src: reverse_proxy.conf.j2
        dest: "{{ temp_config }}"
      notify:
        - reload apache

  handlers:
    - name: reload apache
      service:
        name: apache2
        state: reloaded
